/*
 * NEXTO Configuration File
 * Minimal base configuration - cluster-specific settings in conf/ directory
 */

// Manifest
manifest {
    name = 'NEXTO'
    author = 'Vivek Venkatraman Krishnan'
    description = 'Nextflow-based pulsar search pipeline using PRESTO'
    mainScript = 'nexto_search.nf'
    version = '1.0.0'
    nextflowVersion = '>=23.04.0'
}

// Global parameters
params {
    // Input/Output
    input = null
    outdir = "${baseDir}/results"

    // Singularity container
    presto_container = "/homes/vkrishnan/dev/dockers/PrestoZL/prestozl_20112025_latest.sif"
    pulsarx_container = "/b/u/vishnu/SINGULARITY_IMAGES/pulsarx_latest.sif"
    singularity_cachedir = "/bscratch/singularity_cache"

    // Computational resources (overridden by cluster configs)
    max_cpus = 2
    max_memory = '16.GB'
    max_time = '240.h'

    // Search parameters
    dm_low = 619.0
    dm_high = 620.0
    dm_step = 0.5
    downsample = 1
    search_params = [[0,0],[50,0],[200,0],[200,400],[400,800]] // List of [zmax, wmax] tuples
    numharm = 8
    sigma_threshold = 2.0

    // Segmentation parameters
    segments = [["full", 1.0], ["half", 0.5]]  // List of [name, fraction] tuples
    publish_timeseries = false  // Publish .dat/.inf files (can be large)

    // Sifting parameters
    period_to_search_min = 0.001  // seconds
    period_to_search_max = 15.0   // seconds
    flag_remove_duplicates = true
    flag_remove_harmonics = true

    // Filtool parameters
    enable_filtool = false
    filtool_time_decimate = 1
    filtool_freq_decimate = 1
    filtool_telescope = "meerkat"
    filtool_rfi_filter = "kadaneF 8 4 zdot"
    filtool_extra_args = ""

    // RFI parameters
    rfifind_time = 2.0
    rfifind_freqsig = 4.0

    // Extra flags for customization
    rfifind_extra_flags = ""
    prepdata_extra_flags = ""
    accelsearch_extra_flags = ""
    prepfold_extra_flags = ""

    // Folding parameters
    npart = 50
    max_cands_to_fold = 100
    
    fold_with_psrfold = false
    psrfold_nbin = 4
    psrfold_extra_flags = ""
    fold_template="/home/pulsarx/software/PulsarX/include/template/meerkat_fold.template"

    // GPU parameters
    use_cuda = false
    gpu_id = 0

    // Single pulse search
    sp_threshold = 5.0
    enable_single_pulse = true
}

// Default process configuration
process {
    // Default resources (overridden by cluster configs)
    cpus = 1
    memory = '4.GB'
    time = '1.h'
}

// Execution profiles
profiles {
    // Standard local execution
    standard {
        process.executor = 'local'
        process.cpus = 1
        process.memory = '4.GB'
    }

    // Local execution with more resources
    local {

        process.executor = 'local'
        process.cpus = params.max_cpus
        process.memory = params.max_memory

        apptainer.enabled = true
        apptainer.autoMounts = false
        apptainer.runOptions = '--env="CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES}" -B /b -B /bscratch -B /homes --nv'
        apptainer.cacheDir = params.singularity_cachedir
        apptainer.envWhitelist = 'APPTAINER_BINDPATH,APPTAINER_LD_LIBRARY_PATH'

    }

   

    // ========================================================================
    // HPC CLUSTER PROFILES
    // ========================================================================

    // OzSTAR cluster (Swinburne, SLURM)
    ozstar {
        includeConfig 'conf/ozstar.config'
    }

    // Hercules cluster (MPIfR Bonn, SLURM)
    hercules {
        includeConfig 'conf/hercules.config'
    }

    // Contra cluster (MPIfR Bonn, HT-Condor)
    contra {
        includeConfig 'conf/contra.config'
    }
}

// Trace and report options
trace {
    enabled = true
    file = "${params.outdir}/pipeline_trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outdir}/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.outdir}/report.html"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_dag.svg"
    overwrite = true
}

// Cleanup
cleanup = false

